<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
      body { 
        margin: 0; 
        padding: 0; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background-color: #1f2937;
        color: #f3f4f6; 
    }

    .navbar { 
        background-color: #374151; 
        padding: 15px 30px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .navbar h2 {
        color: #f3f4f6; 
        margin: 0;
    }
    .navbar a { 
        text-decoration: none; 
        color: white; 
        padding: 8px 12px; 
        border-radius: 6px; 
        background-color: #ef4444; 
        font-weight: 600; 
        transition: background-color 0.3s;
    }
    .navbar a:hover {
        background-color: #dc2626;
    }

    .dashboard-container { 
        max-width: 1200px; 
        margin: 30px auto;
        padding: 0 20px; 
    }
    h1 { 
        color: #a78bfa; 
        margin-bottom: 25px; 
        text-align: center;
    }
    h3 {
        color: #a78bfa;
        text-align: center;
        margin-top: 40px;
        margin-bottom: 20px;
        font-size: 1.5em;
    }
    
    .data-table { 
        width: 100%; 
        border-collapse: collapse; 
        box-shadow: 0 0 15px rgba(0,0,0,0.3); 
        background-color: #374151;
        border-radius: 4px;
        overflow: hidden; 
        margin-bottom: 40px;
    }
    .data-table th, .data-table td { 
        padding: 15px; 
        text-align: left; 
        border-bottom: 1px solid #4b5563;
    }
    .data-table th { 
        background-color: #1e3a8a; 
        color: #f3f4f6; 
        font-weight: 600; 
    }
    .data-table tr:hover { 
        background-color: #4b5563; 
    }
    .status-active { background-color: #10b981; color: #1f2937; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .status-inactive { background-color: #ef4444; color: #1f2937; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .btn-delete { background-color: #ef4444; color: white; padding: 8px 12px; border: none; cursor: pointer; border-radius: 4px; transition: background-color 0.3s;}
    .btn-delete:hover { background-color: #dc2626; }
    .btn-toggle-key { background: none; border: none; color: #60a5fa; cursor: pointer; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="navbar">
        <h2 style="margin:0; color:white;">Admin Dashboard</h2>
        <a href="/admin/logout">Logout</a>
    </div>

    <div class="dashboard-container">
    <h1 style="margin-bottom: 0;">Pengelolaan Pengguna dan API Key</h1>

    <p id="message-area" style="color:#10b981; margin-bottom: 15px; font-weight: bold; text-align: center;"></p>

    <h3>Daftar Pengguna Sistem</h3>
<table class="data-table">
    <thead>
        <tr>
            <th>ID User</th>
            <th>Nama Lengkap</th>
            <th>Email</th>
            <th>Aksi</th> 
            </tr>
    </thead>
    <tbody id="user-data-body">
        </tbody>
</table>

<h3>Detail API Key (Aktif & Nonaktif)</h3>
<table class="data-table">
    <thead>
        <tr>
            <th>ID User</th>
            <th>API Key</th>
            <th>Expires At</th>
            <th>Status Key</th>
        </tr>
    </thead>
    <tbody id="api-key-data-body">
        </tbody>
</table>
</div>
    <script>
        const API_DATA_ENDPOINT = '/api/users/data'; 

        async function fetchUserData() {
            try {
                const response = await fetch('/admin/dashboard-data');
                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari server.');
                }
                const users = await response.json();
                renderTable(users);
            } catch (error) {
                document.getElementById('user-data-body').innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">${error.message}</td></tr>`;
                document.getElementById('message-area').style.color = 'red';
                document.getElementById('message-area').textContent = 'Error: Gagal memuat data.';
            }
        }

function renderTable(users) {
    const userTbody = document.getElementById('user-data-body');
    const keyTbody = document.getElementById('api-key-data-body'); 
    
    userTbody.innerHTML = '';
    keyTbody.innerHTML = '';
    
    if (users.length === 0) {
        userTbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Tidak ada data pengguna.</td></tr>`;
        keyTbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Tidak ada data kunci.</td></tr>`;
        return;
    }

    users.forEach(user => {
        const fullName = `${user.first_name} ${user.last_name}`;
        
        const userRow = userTbody.insertRow();
        userRow.insertCell().textContent = user.user_id;
        userRow.insertCell().textContent = fullName;
        userRow.insertCell().textContent = user.email;
        
        const actionCell = userRow.insertCell();
        actionCell.innerHTML = `
            <form action="/admin/delete-user/${user.user_id}" method="POST" onsubmit="return confirm('Yakin ingin menghapus user ${user.email}?')">
                <button type="submit" class="btn-delete">Hapus</button>
            </form>
        `;
        if (user.api_key) {
            const keyRow = keyTbody.insertRow();
            const keyId = `key-${user.user_id}`;
            const maskedKey = '********';
            const statusClass = user.status === 'Active' ? 'status-active' : 'status-inactive';

            keyRow.insertCell().textContent = user.user_id; // ID User

            // Kolom API Key dengan Toggle
            const keyCell = keyRow.insertCell();
            keyCell.innerHTML = `
                <span id="masked-${keyId}">${maskedKey}</span>
                <span id="full-${keyId}" style="display:none; font-family:monospace;">${user.api_key}</span>
                <button class="btn-toggle-key" onclick="toggleKey('${keyId}', this)">Lihat</button>
            `;
            
            // Kolom Expires At
            keyRow.insertCell().textContent = user.expires_at ? new Date(user.expires_at).toLocaleDateString() : 'N/A';
            
            // Kolom Status Key
            keyRow.insertCell().innerHTML = `<span class="${statusClass}">${user.status}</span>`;
        }
    });
}
        
        function toggleKey(keyId, button) {
            const masked = document.getElementById(`masked-${keyId}`);
            const full = document.getElementById(`full-${keyId}`);
            
            if (masked.style.display !== 'none') {
                masked.style.display = 'none';
                full.style.display = 'inline';
                button.textContent = 'Sembunyikan';
            } else {
                masked.style.display = 'inline';
                full.style.display = 'none';
                button.textContent = 'Lihat';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchUserData);
        
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get('msg');
        const error = urlParams.get('error');

        if (msg) {
            document.getElementById('message-area').textContent = decodeURIComponent(msg);
        } else if (error) {
            document.getElementById('message-area').style.color = 'red';
            document.getElementById('message-area').textContent = decodeURIComponent(error);
        }
    </script>
</body>
</html>